<?xml version="1.0" encoding='utf-8' ?>
<!doctype
    html public "-//w3c//dtd xhtml 1.1//en"
    "http://www.w3.org/tr/xhtml11/dtd/xhtml11.dtd">
<html xml:lang="en-US">
<head>
<title>NovoSial.org: Debugging Perl Distribution Build Problems</title>
<meta name="keywords" content="sial.org, unix, openssl, ssh"/>
<meta name="msvalidate.01" content="4D4AA5634CCCC8B90DD61AC8A12D742B" />
<meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="generator" content="XML::ApplyXSLT, libxml, and Perl"/>
<link rel="stylesheet" type="text/css" href="../default.css"/><meta name="MSSmartTagsPreventParsing" content="TRUE"/>
</head>
<body>

    <div class="header"><h1>Debugging Perl Distribution Build Problems</h1></div>

    <div class='mainBody'>
      <div class="subsection"><a href="#s2">Missing Libraries</a> | <a href="#s3">Verbose Testing</a> | <a href="#s4">Interactive Modules</a> | <a href="#s5">Bypass tests with <tt class="cmd">force install</tt></a> | <a href="#s6">Fixing Bugs</a></div><div class="bodymain"><p class="info">Perl distributions from the <a href="http://www.cpan.org/">Comprehensive Perl Archive Network (CPAN)</a> may fail to build for a variety of reasons. Inspect the output, and run the tests in verbose mode. The <a href="http://search.cpan.org/perldoc/CPAN" title="Documentation on the CPAN Perl module"><tt class="perl-module">CPAN</tt></a> module configuration or <a href="http://novosial.org/perl/life-with-cpan/ftp-problems/">network problems</a> may prevent modules from being downloaded. See <a href="../index.html">Life with CPAN for more information</a>.</p><p class="info">Compiling Perl modules requires <tt class="cmd">make</tt> and other development utilities. Ensure these are installed on the build system. Installation of these tools will vary by operating system, either requiring ports or packages to be installed (<tt class="cmd">apt-get install build-essential</tt> on Debian Linux), or a <a href="http://developer.apple.com/tools/xcode/">development kit</a> from the vendor.</p><p class="info">Knowledge of how to build and <a href="http://novosial.org/debug/unix/">debug software on Unix</a> is required. Consult the vendor supplied developer documentation, if any, along with the <tt class="file">README</tt> file provided with the module.</p><p class="info">If the install has previously failed, <a href="http://search.cpan.org/perldoc/CPAN" title="Documentation on the CPAN Perl module"><tt class="perl-module">CPAN</tt></a> may cache this result. In the <tt class="code">cpan</tt> shell, run <tt class="cmd">clean Module::Name</tt>, or otherwise cleanup the <tt class="file">~/.cpan/build</tt> directory to start over, especially if the build logs need to be saved with <a href="http://www.FreeBSD.org/cgi/man.cgi?query=script&sektion=1" title="FreeBSD man page search for script, section 1"><tt xmlns:xlink="http://www.w3.org/1999/xlink" class="man">script(1)</tt></a> or <a href="http://www.FreeBSD.org/cgi/man.cgi?query=tee&sektion=1" title="FreeBSD man page search for tee, section 1"><tt xmlns:xlink="http://www.w3.org/1999/xlink" class="man">tee(1)</tt></a> for easier inspection:</p><p class="data-shell">$ <kbd>rm -rf ~/.cpan/build</kbd><br/>$ <kbd>cpan XML::LibXSLT 2&gt;&amp;1 | tee build.log</kbd><br/>?</p><p class="info">If a bug is found, contact the module author with a patch or bug report. Include as much relevant detail as possible, such as the output from <tt class="cmd">perl -V</tt>, the operating system, and so forth.</p><h3><a name="s1.1">Getting Help</a></h3><p class="info">If the error message is beyond your abilities, <a href="http://perl.net.au/wiki/Freenode_Sharp_Perl_FAQ">request help</a> only with the appropriate build logs. The complete build logs from a clean build are required for others to help with the build problem. Use <a href="http://www.FreeBSD.org/cgi/man.cgi?query=script&sektion=1" title="FreeBSD man page search for script, section 1"><tt xmlns:xlink="http://www.w3.org/1999/xlink" class="man">script(1)</tt></a> to record the build session (or copy and paste the complete logs) and be sure to edit out any passwords or other site-specific details from the build log. However, include as much data as possible.</p><p class="info">To restart from scratch, remove the <a href="http://search.cpan.org/perldoc/CPAN" title="Documentation on the CPAN Perl module"><tt class="perl-module">CPAN</tt></a> <tt class="file">build</tt> directory. This will either be set in the user-specific <tt class="file">~/.cpan/CPAN/MyConfig.pm</tt> file, or the <tt class="file">CPAN/Config.pm</tt> file somewhere under <a href="http://search.cpan.org/perldoc/perlvar"><tt class="code">@INC</tt></a> for <tt class="code">root</tt>:</p><p class="data-shell">$ <kbd>grep build_dir ~/.cpan/CPAN/MyConfig.pm</kbd><br/>  'build_dir' =&gt; q[<em class="em">/home/user/.cpan/build</em>],<br/>$ <kbd>perl -MCPAN::Config -le 'print $INC{"CPAN/Config.pm"}' \<br/>  | xargs grep build_dir</kbd><br/>  'build_dir' =&gt; q[<em class="em">/var/root/.cpan/build</em>],</p><p class="info">Then rebuild the module, saving the complete build logs.</p><h2><a name="s2">Missing Libraries</a></h2><p class="info">Perl modules that rely on C libraries may issue misleading errors if the required library and header files are not installed, or if an incompatible version of the library is installed. ?Probably harmless? missing library warnings are usually not harmless at all, for example when installing <a href="http://search.cpan.org/perldoc/XML::LibXML::Common" title="Documentation on the XML::LibXML::Common Perl module"><tt class="perl-module">XML::LibXML::Common</tt></a>. For the missing <tt class="code">-lxml2</tt> warning to be satisfied, a file such as <tt class="file-glob">libxml2.*</tt> must first be installed on the system. Library files may use <tt class="file-glob">*.a</tt>, <tt class="file-glob">*.so</tt>, or <tt class="file-glob">*.dylib</tt> extensions, depending on the platform. Either build the source manually for <a href="http://xmlsoft.org/">Libxml2</a>, or install it from a vendor supplied port or package system.</p><p class="data">Note (probably harmless): No library found for -lxml2</p><p class="info">Another common error will be for missing header files (e.g. <tt class="file">expat.h</tt>) which again points to missing development libraries (e.g. <tt class="code">libexpat</tt>). Libraries installed to custom locations, such as under a special software ports tree, may require setting <tt class="code">LD_LIBRARY_PATH</tt> and other environment variables to properly locate the library and header files.</p><h2><a name="s3">Verbose Testing</a></h2><p class="info">Verbose testing may provide more detail on why a <tt class="cmd">make test</tt> run fails. This can be done with the <tt class="code">look</tt> command under the <a href="http://search.cpan.org/perldoc/CPAN" title="Documentation on the CPAN Perl module"><tt class="perl-module">CPAN</tt></a> shell plus the subsequent Unix shell commands shown below. Be sure to inspect the test scripts under the <tt class="file">t</tt> directory to compare the error message with the code that generated the message.</p><p class="data-shell">cpan&gt; <kbd>install HTML::Mason</kbd><br/>Running install for module HTML::Mason<br/>Running make for D/DR/DROLSKY/HTML-Mason-1.23.tar.gz<br/>?<br/>t/02a-filter..........ok                                                     <br/>t/04-misc.............FAILED tests 9-10                                      <br/>        Failed 2/11 tests, 81.82% okay<br/>t/05-request..........ok                                                     <br/>?<br/>Failed Test Stat Wstat Total Fail  Failed  List of Failed<br/>---------------------------------------------------------------------------<br/>t/04-misc.t               11    2  18.18%  9-10<br/>2 tests skipped.<br/>Failed 1/23 test scripts, 95.65% okay. 2/376 subtests failed, 99.47% okay.<br/>*** Error code 35<br/><br/>Stop in /var/spool/cpan/build/HTML-Mason-1.23.<br/>  /usr/bin/make test -- NOT OK<br/>Running make install<br/>  make test had returned bad status, won't install without force<br/><br/>cpan&gt; <br/>cpan&gt; <kbd>look HTML::Mason</kbd><br/>Running look for module HTML::Mason<br/><br/>Trying to open a subshell in the build directory...<br/>Working directory is /var/spool/cpan/build/HTML-Mason-1.23<br/># <kbd>make test TEST_VERBOSE=1 TEST_FILE=t/04-misc.t | tee test.log</kbd><br/>?</p><p class="info">Consider also installing <a href="http://search.cpan.org/perldoc/Test::Harness" title="Documentation on the Test::Harness Perl module"><tt class="perl-module">Test::Harness</tt></a>, as this includes the <tt class="cmd">prove</tt> command:</p><p class="data-shell">$ <kbd>make</kbd><br/>?<br/>$ <kbd>prove -b -v t/04-misc.t | tee test.log</kbd></p><h2><a name="s4">Interactive Modules</a></h2><p class="info">Poorly written modules may attempt to prompt the user for input during the build or testing process. This introduces a fragile captive user interface that may be difficult or impossible to automate. The <a href="http://search.cpan.org/perldoc/ExtUtils::MakeMaker" title="Documentation on the ExtUtils::MakeMaker Perl module"><tt class="perl-module">ExtUtils::MakeMaker</tt></a> supplied <tt class="code">prompt</tt> subroutine may be disabled by closing standard input, or setting the <tt class="code">PERL_MM_USE_DEFAULT=1</tt> environment variable. Then inspect the test scripts to see what environment variables they expect. For example, <a href="http://search.cpan.org/perldoc/WWW::Curl" title="Documentation on the WWW::Curl Perl module"><tt class="perl-module">WWW::Curl</tt></a> 3.02 will hang while building on <a href="http://www.apple.com/macosx/">Mac OS X</a> (as of version 10.4.9) unless the following environment variables are set:</p><p class="data-shell">$ <kbd>env PERL_MM_USE_DEFAULT=1 \<br/>   CURL_TEST_URL=http://example.org/ \<br/>   make test</kbd></p><h3><a name="s4.1">Process Tracing Method</a></h3><p class="info">The cause of the hang can be determined using a process tracing utility, such as <a href="http://www.FreeBSD.org/cgi/man.cgi?query=ktrace&sektion=1&manpath=darwin" title="FreeBSD man page search for ktrace, section 1 on darwin"><tt xmlns:xlink="http://www.w3.org/1999/xlink" class="man">ktrace(1)</tt></a>. <a href="http://novosial.org/debug/unix/">Unix Debugging Tips</a> contains more information on debugging systems with <tt class="cmd">ktrace</tt> or <tt class="cmd">strace</tt>.</p><p class="data-shell">$ <kbd>perl Makefile.PL</kbd><br/>Found curl.h in /usr/include/curl/curl.h<br/>Building curlopt-constants.c for your libcurl version<br/>Building Easy.pm constants for your libcurl version<br/>Checking if your kit is complete...<br/>Looks good<br/>Writing Makefile for WWW::Curl<br/>$ <kbd>make</kbd><br/>?<br/>$ <kbd>ktrace -di make test</kbd><br/>PERL_DL_NONLAZY=1 /usr/bin/perl "-MExtUtils::Command::MM" "-e" <span class="rbr">?</span><br/>"test_harness(0, 'blib/lib', 'blib/arch')" t/*.t<br/>t/00constants.............ok<br/>t/01basic.................</p><p class="info">On Mac OS X, use the <a href="http://www.FreeBSD.org/cgi/man.cgi?query=kdump&sektion=1&manpath=darwin" title="FreeBSD man page search for kdump, section 1 on darwin"><tt xmlns:xlink="http://www.w3.org/1999/xlink" class="man">kdump(1)</tt></a> utility to inspect the <tt class="file">ktrace.out</tt> file for the hung process shown above:</p><p class="data-shell">$ <kbd>kdump -f ktrace.out | tail</kbd><br/>  1804 perl     RET   write 34/0x22<br/>  1800 perl     GIO   fd 15 read 34 bytes<br/>       "# Please enter an URL to fetch [] "<br/>  1800 perl     RET   read 34/0x22<br/>  1800 perl     CALL  read(0xf,0x185ce00,0x1000)<br/>  1804 perl     CALL  fstat(0,0xbfffc1a8)<br/>  1804 perl     RET   fstat 0<br/>  1804 perl     CALL  ioctl(0,0x4004667a ,0xbfffc128)<br/>  1804 perl     RET   ioctl 0<br/>  1804 perl     CALL  read(0,0x37000,0x20000)</p><p class="info">This indicates the script wants a URL, but for some reason the fragile prompt is broken. Inspecting the <tt class="file">t/01basic.t</tt> script reveals the <tt class="code">CURL_TEST_URL</tt> environment variable should be set.</p><h2><a name="s5">Bypass tests with <tt class="cmd">force install</tt></a></h2><p class="info">Errors during the <tt class="cmd">make test</tt> phase can be skipped using <tt class="cmd">force install</tt> under the CPAN shell. This should only be done if the module is being installed for testing, or if the tests are known to not work, and the module is therefore safe for production use. Note that <tt class="cmd">force install</tt> only forces the module, not any of the module dependencies. If the dependencies have any problems, investigate and fix those before attempting to install the module.</p><p class="data-shell">cpan&gt; <kbd>force install HTML::Mason</kbd></p><p class="info"><em class="em">If you <tt class="cmd">force install</tt> broken code to a production system, shame on you!</em> Development systems can suffer the dangers of random module installs. Test and production systems should instead use a local package or software depot that contains the tested, working version of the module. This localized software can then be reproduced as needed onto new production systems. Code from CPAN may not be reproducible, as the author could upload a new, incompatible module version, or delete the entire module without warning (though old versions of the module may be available on <a href="http://backpan.cpan.org/">backpan</a>).</p><p class="info">To avoid installing modules into system areas, consult <a href="../non-root/index.html">using CPAN with a non-root account</a>.</p><h2><a name="s6">Fixing Bugs</a></h2><p class="info">If possible, fix the bug. Test scripts could need tweaks, or support for an environment variable that toggles tests that could easily fail. Consider <a href="http://www.simplicidade.org/notes/archives/2009/03/easy_yak_shavin.html">git-cpan-init</a>, which offers a quick means to download CPAN modules into <tt class="cmd">git</tt> repositories, and equally easy means to submit tickets to <a href="https://rt.cpan.org/">CPAN RT</a>.</p></div>
    </div>

		<div class="footer"><a href="../"><img style="border: 0; float: right; margin-top: 1em; margin-right: 1em; margin-bottom: 5em" src="http://novosial.org/NovosialLogo.gif" width="64" height="64" alt="NovoSial Icon"/></a>
<p>This document is released into the public domain. Version 1.3.</p></div>
  </body>
</html>
